# ESP32 温湿度时间监控系统

基于ESP32开发板的温湿度时间显示项目，支持OLED显示、Web服务器访问和远程监控。

## 📋 项目简介

本项目使用ESP32开发板，集成AHT20温湿度传感器和OLED显示屏，实现以下功能：
- 从NTP服务器获取网络时间
- 从AHT20读取温度和湿度
- 在OLED屏幕上居中显示时间、温度和湿度
- 启动Web服务器，支持手机/电脑浏览器访问
- 支持外网访问（需配置端口映射）

## 🔧 硬件清单

| 组件 | 型号 | 说明 |
|------|------|------|
| 主控 | ESP32 | 开发板 |
| 显示屏 | SSD1306 OLED 0.96寸 | 128x64像素，I2C接口 |
| 传感器 | AHT20/DHT20 | 温湿度传感器，I2C接口 |
| 电源 | 5V/3.3V | USB或电源适配器 |

## 🔌 硬件连接

### OLED显示屏 (I2C总线0)
| OLED引脚 | ESP32引脚 | 说明 |
|----------|-----------|------|
| VCC | 3.3V | 电源正极 |
| GND | GND | 地线 |
| SCL | GPIO22 | I2C时钟线 |
| SDA | GPIO21 | I2C数据线 |

### AHT20温湿度传感器 (I2C总线1)
| AHT20引脚 | ESP32引脚 | 说明 |
|-----------|-----------|------|
| VCC | 3.3V | 电源正极 |
| GND | GND | 地线 |
| SCL | GPIO5 | I2C时钟线（独立I2C总线） |
| SDA | GPIO4 | I2C数据线（独立I2C总线） |

**注意**：OLED和AHT20使用不同的I2C总线，避免地址冲突。

## 📦 软件依赖

```ini
[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino

lib_deps =
    adafruit/Adafruit AHTX0@^2.0.2
    olikraus/U8g2@^2.34.22
```

## ⚙️ 配置说明

### WiFi配置
在 `main.cpp` 中修改WiFi信息：
```cpp
const char* ssid = "your_wifi_name";      // WiFi名称
const char* password = "your_password";    // WiFi密码
```

### 静态IP配置
ESP32使用固定IP地址（可修改）：
```cpp
IPAddress local_IP(192, 168, 1, 200);     // ESP32固定IP
IPAddress gateway(192, 168, 1, 1);        // 路由器IP
IPAddress subnet(255, 255, 255, 0);       // 子网掩码
```

### NTP时间服务器
默认使用国内NTP服务器，同步速度快：
```cpp
const char* ntpServer = "cn.pool.ntp.org";  // 国内服务器
const long gmtOffset_sec = 8 * 3600;         // 东八区（北京时间）
```

## 🚀 使用方法

### 1. 编译上传
```bash
# 使用PlatformIO
pio run --target upload

# 或在VSCode中按 Ctrl+Alt+U
```

### 2. 查看OLED显示
启动后OLED会显示：
- 日期（小字体）
- 时间（大字体）
- 温度和湿度（中字体）

### 3. 访问Web界面

#### 局域网访问
在手机或电脑浏览器输入ESP32的IP地址：
```
http://192.168.1.200
```

#### 外网访问
已配置端口映射，外网访问地址：
```
http://sumaj.synology.me:7788
```

### 4. API接口

| 接口 | 说明 | 返回格式 |
|------|------|----------|
| `/` | 主页 | HTML页面 |
| `/temperature` | 温度数据 | 纯文本 "25.3°C" |
| `/humidity` | 湿度数据 | 纯文本 "65.2%" |
| `/json` | JSON数据 | JSON格式 |

#### API示例
```bash
# 获取温度
curl http://192.168.1.200/temperature

# 获取湿度
curl http://192.168.1.200/humidity

# 获取JSON数据
curl http://192.168.1.200/json

# JSON返回示例:
{
  "temperature": 25.3,
  "humidity": 65.2,
  "time": "14:30:45",
  "date": "2025-01-27",
  "status": "ok"
}
```

## 📊 OLED显示布局

```
┌────────────────────────────────┐
│                                │
│     2025-01-27    ← Y=12      │  日期 (8pt字体)
│                                │
│      14:30:45       ← Y=38     │  时间 (18pt字体)
│                                │
│   25.3°C  65.2%     ← Y=60     │  温湿度 (12pt字体)
│                                │
└────────────────────────────────┘
```

## 🔄 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         ESP32 主控芯片                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │   U8g2 OLED  │    │   AHT20      │    │   WiFi模块    │     │
│  │   显示屏      │    │  温湿度传感器 │    │   Web服务器  │     │
│  │  I2C: GPIO22 │    │  I2C: GPIO4  │    │   Port:80    │     │
│  │       GPIO21 │    │       GPIO5   │    └──────────────┘     │
│  └──────────────┘    └──────────────┘                         │
│                                                                 │
│  ┌──────────────┐    ┌──────────────┐                         │
│  │   看门狗     │    │  NTP时间     │                         │
│  │  30秒超时    │    │  同步服务    │                         │
│  └──────────────┘    └──────────────┘                         │
└─────────────────────────────────────────────────────────────────┘
```

## 📋 主程序流程

### setup() 初始化流程
```
1. 初始化串口 (115200波特率)
2. 初始化OLED显示屏 (U8g2)
3. 初始化AHT20温湿度传感器
4. 启动看门狗 (30秒超时)
5. 连接WiFi网络
6. 同步NTP时间 (最多5秒)
7. 配置静态IP
8. 配置Web服务器路由
9. 启动Web服务器
```

### loop() 主循环流程
```
每秒执行一次：
1. 喂看门狗 (防止系统重启)
2. 检查WiFi连接 (每30秒)
3. 检查NTP时间同步 (每10分钟)
4. 监控剩余内存
5. 获取本地时间
6. 读取AHT20温湿度
7. 更新全局变量
8. OLED显示更新
9. 串口输出调试信息
10. 处理Web请求
11. 延迟1秒
```

## 🛡️ 系统保护机制

| 机制 | 说明 | 参数 |
|------|------|------|
| 看门狗 | 防止程序卡死，超时重启 | 30秒 |
| WiFi重连 | 自动检测并重连WiFi | 每30秒检查 |
| 重连限制 | 重连失败超过次数重启 | 5次 |
| NTP同步 | 定期同步网络时间 | 每10分钟 |
| 内存监控 | 剩余内存警告 | <30KB |

## 🌐 Web服务器功能

### 主页功能
- 美观的渐变背景UI
- 实时显示温度、湿度、时间、日期
- 温度动态颜色显示（蓝色<20°C，橙色20-30°C，红色>30°C）
- 每3秒自动刷新

### API接口
支持跨域访问（CORS），方便第三方程序调用。

## 📱 外网访问配置

如需外网访问，请配置路由器端口映射：

| 外部端口 | 内部IP | 内部端口 | 协议 |
|---------|--------|----------|------|
| 7788 | 192.168.1.200 | 80 | TCP |

## 🐛 故障排除

### WiFi连接失败
- 检查WiFi名称和密码是否正确
- 确认ESP32在路由器信号范围内
- 查看串口输出调试信息

### AHT20读取失败
- 检查I2C接线（GPIO4/5）
- 确认传感器供电正常
- OLED会显示"Sensor Error"

### NTP时间同步失败
- 检查网络连接
- 等待更长时间（首次同步可能需要几秒）
- 系统会在loop中持续尝试

### Web页面无法访问
- 确认ESP32 IP地址
- 检查防火墙设置
- 尝试使用其他设备访问

## 📊 串口输出调试

程序会通过串口（115200波特率）输出以下信息：
- WiFi连接状态
- NTP时间同步结果
- 温湿度数据
- WiFi重连信息
- 内存警告

查看串口输出：
```bash
# Windows
COM端口在设备管理器中查看

# Linux/Mac
ls /dev/tty.usb*
screen /dev/tty.usbserial-xxx 115200
```

## 📝 技术要点

### I2C通信
- OLED使用I2C总线0（GPIO21/22）
- AHT20使用I2C总线1（GPIO4/5）
- 双总线避免地址冲突

### NTP时间协议
- 使用国内NTP服务器 `cn.pool.ntp.org`
- 时区设置为UTC+8（北京时间）
- 首次同步最多等待5秒

### U8g2字体库
- 支持多种字体大小
- UTF-8编码支持中文
- 缓冲区模式高效显示

### 看门狗机制
- 任务看门狗：30秒超时
- panic模式：超时自动重启
- 循环中定期喂狗

## 📄 许可证

本项目仅供学习参考。

## 📮 联系方式

如有问题，请通过以下方式联系：
- 提交Issue
- 发送邮件

---

**版本**: 1.0.0
**更新日期**: 2025-01-27
